<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MortgageAssist - AI-Powered Mortgage Support</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo"><a href="#"><span class="blue">MORTGAGE</span>ASSIST</a></div>
            <nav>
                <ul>
                    <li><a href="#features">Features</a></li>
                    <li><a href="#how-it-works">How It Works</a></li>
                    <li><a href="#testimonials">Testimonials</a></li>
                    <li><a href="#faq">FAQ</a></li>
                    <li><a href="#" class="btn-primary" id="howMuchBtn">How Much?</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <div class="key-icon">🔑</div>
                <h1>Mortgage Questions? Get Answers Instantly.</h1>
                <p>Skip the hold music. Our AI assistant helps with loan status, paperwork, and rate updates—day or night.</p>
                <a href="#chatbot" class="btn-primary">Ask Your Mortgage Question →</a>
            </div>
        </div>
    </section>

    <section id="chatbot" class="chatbot-section">
        <div class="container">
            <h2>Ask Our AI Assistant</h2>
            
            <div class="chatbot-wrapper">
                <!-- Left chat bubble example -->
                <div class="example-chat-left">
                    <div class="user-message">
                        <div class="message-bubble blue">
                            What's my loan's interest rate?
                        </div>
                    </div>
                    <div class="ai-message">
                        <div class="message-bubble white border-green">
                            Your rate is 6.25% (30-year fixed).
                        </div>
                    </div>
                </div>
                
                <!-- Chatbase embed iframe -->
                <div class="chatbot-container">
                    <iframe
                        src="https://www.chatbase.co/chatbot-iframe/JKHQAJDGl0bRE-7LSQkv4"
                        width="100%"
                        style="height: 520px;"
                        frameborder="0"
                    ></iframe>
                </div>
                
                <!-- Right chat bubble example -->
                <div class="example-chat-right">
                    <div class="user-message">
                        <div class="message-bubble blue">
                            What documents do I need to upload?
                        </div>
                    </div>
                    <div class="ai-message">
                        <div class="message-bubble white border-green">
                            You're missing your 2023 W-2. Upload here.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="features" class="benefits-section">
        <div class="container">
            <h2>Key Benefits</h2>
            <div class="benefits-grid">
                <div class="benefit-card">
                    <div class="benefit-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                    </div>
                    <h3>Loan Status Updates</h3>
                    <p>Get real-time updates on your application progress</p>
                    <div class="quote">"Where's my application in underwriting?"</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <h3>Document Checklists</h3>
                    <p>Never miss important paperwork deadlines</p>
                    <div class="quote">"What's needed for closing?"</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="17 18 11 12 17 6"></polyline>
                            <polyline points="7 6 1 12 7 18"></polyline>
                        </svg>
                    </div>
                    <h3>Rate Comparisons</h3>
                    <p>Make informed decisions about rate locking</p>
                    <div class="quote">"Should I lock my rate today?"</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                    </div>
                    <h3>Payment Calculators</h3>
                    <p>Instantly see how changes affect your payment</p>
                    <div class="quote">"What's my new monthly payment?"</div>
                </div>
            </div>
        </div>
    </section>

    <section id="how-it-works" class="how-it-works">
        <div class="container">
            <h2>How It Works</h2>
            <div class="steps-container">
                <div class="step">
                    <div class="step-number">1</div>
                    <h3>Ask</h3>
                    <p>Type your question (e.g., "Has my appraisal been scheduled?").</p>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <h3>Answer</h3>
                    <p>AI responds instantly with accurate details.</p>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <h3>Act</h3>
                    <p>Upload files or book a call if needed.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="testimonials" class="testimonials">
        <div class="container">
            <h2>What Our Clients Say</h2>
            <div class="testimonial">
                <p class="quote">"Clients love the instant updates—our team saves 15+ hours/week!"</p>
                <p class="author">- [Loan Officer Name], [Company]</p>
            </div>
            <div class="stat">
                <div class="stat-number">40%</div>
                <div class="stat-description">fewer calls to our office since launch</div>
            </div>
        </div>
    </section>

    <section id="faq" class="faq-section">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-grid">
                <div class="faq-item">
                    <h3>How do I lock my rate?</h3>
                    <p>You can lock your rate through our AI assistant or by contacting your loan officer directly. Rate locks typically last for 30, 45, or 60 days depending on your loan.</p>
                </div>
                <div class="faq-item">
                    <h3>What's the next step in my process?</h3>
                    <p>Our AI assistant can provide real-time updates on where you are in the mortgage process and what's needed next. Just ask "What's my next step?" or "What's my loan status?"</p>
                </div>
                <div class="faq-item">
                    <h3>Can I change my loan type?</h3>
                    <p>Yes, in many cases you can change your loan type during the application process. Ask our AI assistant about your options or schedule a call with your loan officer to discuss the benefits of different loan programs.</p>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-info">
                <div class="footer-item">Secure & confidential</div>
                <div class="footer-item">NMLS-licensed expertise</div>
                <div class="footer-item">Bank-level encryption</div>
            </div>
        </div>
    </footer>

    <!-- Contact Form Modal - Using Netlify Forms -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <!-- Fine-Tunable Header with CSS Variables -->
<div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px; padding: 10px 0;">
    
    <!-- LEFT SIDE: Business Logo + Get a Quote -->
    <div style="flex: 1;">
        <!-- BUSINESS LOGO - Adjustable -->
        <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/form-assets/logos/logo_5f42f026-051a-42c7-833d-375fcac74252_1754796297597_logo3.png" 
             style="
                height: 150px;                    /* ADJUST: Logo size (try 60px, 80px, 90px) */
                margin-bottom: 30px;             /* ADJUST: Space below logo (try 8px, 15px, 20px) */
                margin-left: -8px;                /* ADJUST: Logo left position (try 5px, 10px, -5px) */
                display: block;
             ">
        
        <!-- GET A QUOTE TEXT - Adjustable -->
        <h2 style="
            margin: 0; 
            font-size: 24px;                    /* ADJUST: Text size (try 20px, 26px, 28px) */
            color: #333; 
            text-align: left;
            margin-left: 0px;                   /* ADJUST: Text left position (try 5px, 10px, -5px) */
            margin-top: 5px;                    /* ADJUST: Space above text (try 0px, 10px, 15px) */
        ">Get a Quote</h2>
    </div>
    
    <!-- RIGHT SIDE: Avatar - Adjustable -->
    <div style="
        flex: 0 0 auto; 
        text-align: center;
        margin-right: -5px;                     /* ADJUST: Avatar right position (try 0px, 15px, 20px) */
        margin-top:  0px;                       /* ADJUST: Avatar vertical position (try 0px, -10px, 5px) */
    ">
        <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/avatars/avatar_1754908037816_AI%20assist%20with%20button2.png" 
             onclick="activateAIAssistant()" 
             style="
                width: 250px;                   /* ADJUST: Avatar size (try 100px, 120px, 130px) */
                cursor: pointer; 
                border-radius: 10px; 
                transition: transform 0.3s;
             "
             onmouseover="this.style.transform='scale(1.05)'"
             onmouseout="this.style.transform='scale(1.0)'">
        <p style="
            margin: 3px 0 0 0; 
            font-size: 11px;                    /* ADJUST: Caption size (try 10px, 12px, 13px) */
            color: #666;
        "></p>
    </div>
    
</div>
            <!-- Using Netlify Forms -->
            <form id="contactForm" name="contact" method="POST" data-netlify="true">
                <!-- Netlify form name -->
                <input type="hidden" name="form-name" value="contact">
                
                <div class="form-group">
                    <label for="name">Your Name</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="businessName">Business Name</label>
                    <input type="text" id="businessName" name="businessName" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="bestTime">Best Time to Contact</label>
                    <input type="text" id="bestTime" name="bestTime" required>
                </div>
                <div class="form-group">
                    <label for="preferredDate">Preferred Date to Contact</label>
                    <input type="date" id="preferredDate" name="preferredDate" required>
                </div>
                <button type="submit" class="btn-primary btn-full">Submit</button>
            </form>
        </div>
    </div>

    <!-- Hidden form for Netlify Forms detection -->
    <form name="contact" netlify netlify-honeypot="bot-field" hidden>
        <input type="text" name="name" />
        <input type="text" name="businessName" />
        <input type="tel" name="phone" />
        <input type="text" name="bestTime" />
        <input type="date" name="preferredDate" />
    </form>

    <script src="js/main.js"></script>
    <!-- Removed the chatbot.js script since we're using the Chatbase iframe -->
<script>
// Enhanced AI Avatar System with VAPI Integration - COMPLETE FIXED VERSION
const mortgageKnowledge = {
    expertResponses: {
        "mortgage": "A mortgage is a loan to buy your home. You pay it back monthly over 15-30 years. Your payment includes principal, interest, taxes, and insurance.",
        "loan types": "Main types are: **Conventional** (3% down, 620+ credit), **FHA** (3.5% down, 580+ credit), **VA** (0% down for veterans), and **USDA** (0% down, rural areas).",
        "qualification": "You need good credit, stable income, acceptable debt-to-income ratio, and down payment. Most programs require 580+ credit score and 3-43% DTI.",
        "down payment": "Down payments range from 0-20%. FHA needs just 3.5%, conventional starts at 3%, VA and USDA can be 0%. The more you put down, the lower your monthly payment!",
        "credit score": "Credit requirements: Conventional (620+), FHA (580+), VA (no minimum), USDA (640+). Higher scores get better rates!",
        "interest rates": "Current mortgage rates are competitive! Rates depend on your credit score, down payment, and loan type. I can help you understand what affects your rate.",
    }
};

// VAPI Configuration with Make.com Webhook
const VAPI_CONFIG = {
    assistantId: '78b68206-657e-421b-8f90-d2256bd1b10e',
    phoneNumber: '949-332-3567',
    webhookUrl: 'https://hook.us2.make.com/xuog6w6jv3ftcxrfscjk6wompv5kupr0'
};

// Voice System Variables
let speechSynthesis = window.speechSynthesis;
let recognition = null;
let isVoiceChatMode = false;
let isListening = false;

// Form Assistant Variables
let currentFormFieldIndex = 0;
let formFieldsArray = [];
let isFormAssistantActive = false;

// Initialize Speech Recognition
function initializeSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript.trim();
            if (isFormAssistantActive) {
                handleFormFieldResponse(transcript);
            } else if (isVoiceChatMode) {
                handleVoiceChatInput(transcript);
            }
        };
        
       recognition.onerror = function(event) {
    console.log('Speech recognition error:', event.error);
    
    // DON'T stop listening for these recoverable errors:
    if (event.error === 'not-allowed' || 
        event.error === 'audio-capture' || 
        event.error === 'network') {
        console.log('Recoverable error - keeping microphone alive');
        return; // Don't call stopListening()
    }
    
    // Only stop for fatal errors
    if (event.error === 'aborted' || event.error === 'language-not-supported') {
        stopListening();
    }
};
        
       recognition.onend = function() {
    // Don't stop listening if form assistant is active
    if (isFormAssistantActive) {
        console.log('[DEBUG] Recognition ended but form assistant active - restarting...');
        if (!isListening) {
            isListening = true;
            try {
                window.speechRecognition.start();
                console.log('[DEBUG] Recognition restarted for form assistant');
            } catch (error) {
                console.log('Error restarting recognition:', error);
            }
        }
    } else {
        // Normal chat mode - stop listening
        isListening = false;
        updateListenButton();
    }
};
    }
}

function initializeMicrophonePermission() {
    // Only request permission on first user interaction
    let permissionRequested = false;
    
    document.addEventListener('click', async function requestMicOnce(e) {
        if (permissionRequested) return;
        
        // Check if clicked on any voice-related element
        if (e.target.closest('#voiceChatButton') || 
            e.target.closest('[onclick*="toggleVoice"]') ||
            e.target.closest('[onclick*="startForm"]')) {
            
            permissionRequested = true;
            console.log('🎤 Requesting microphone permission on first click...');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // Stop immediately
                console.log('✅ Microphone permission granted! No more popups.');
            } catch (error) {
                console.log('❌ Microphone permission denied:', error);
            }
            
            // Remove this listener after first use
            document.removeEventListener('click', requestMicOnce);
        }
    }, { once: false });
}

// Main Avatar Activation Function
function activateAIAssistant() {
    initializeSpeechRecognition();
    showEnhancedAIMenu();
}

// Enhanced 4-Button Menu with NEW AVATAR
function showEnhancedAIMenu() {
    closeAllAIInterfaces();
    
    const menuHTML = `
        <div id="aiOptionsMenu" style="
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 420px; background: white; border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 10000; padding: 30px;
            text-align: center;
        ">
            <!-- NEW AVATAR HEAD -->
            <div style="margin-bottom: 20px;">
                <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/avatars/avatar_1754861585921_AI%20assist%20left2.png" 
                     <img src="..." style="height: 130px; width: auto; margin: 0 auto 20px auto; display: block; box-shadow: 0 0px 0px rgba(0,0,0,0.2);">
<h2 style="margin: 0; color: #333; font-size: 24px;">AI Mortgage Assistant</h2>
                <p style="color: #666; margin: 10px 0 0 0;">How can I help you today?</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <!-- GREEN BUTTON: Help Fill Form -->
                <button onclick="startFormAssistant()" style="
                    background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none;
                    padding: 18px 25px; border-radius: 15px; font-size: 16px; font-weight: bold;
                    cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(76,175,80,0.3);
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    📝 Help Me Fill The Form
                </button>
                
                <!-- BLUE BUTTON: Questions -->
                <button onclick="startQuestionChat()" style="
                    background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none;
                    padding: 16px 25px; border-radius: 15px; font-size: 16px; cursor: pointer;
                    transition: all 0.3s; box-shadow: 0 4px 15px rgba(33,150,243,0.3);
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    💬 I Have Questions
                </button>
                
                <!-- PURPLE BUTTON: Request Callback -->
                <button onclick="showCallbackForm()" style="
                    background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border: none;
                    padding: 16px 25px; border-radius: 15px; font-size: 16px; cursor: pointer;
                    transition: all 0.3s; box-shadow: 0 4px 15px rgba(111,66,193,0.3);
                    display: flex; align-items: center; justify-content: center; gap: 10px;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    📞 Request a Call
                </button>
                
                <!-- RED BUTTON: Close -->
                <button onclick="closeAllAIInterfaces()" style="
                    background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none;
                    padding: 14px 25px; border-radius: 15px; font-size: 14px; cursor: pointer;
                    transition: all 0.3s; box-shadow: 0 4px 15px rgba(244,67,54,0.3);
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    ❌ Close AI Assist
                </button>
            </div>
        </div>
        
        <div id="aiBackdrop" onclick="closeAllAIInterfaces()" style="
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
        "></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', menuHTML);
}

// ============================================================================
// FIX 1: PROPER VOICE-GUIDED FORM ASSISTANT
// ============================================================================

function startFormAssistant() {
    closeAllAIInterfaces();
    
    console.log('1. Starting form assistant...'); 
    
    // Make sure the modal is open
    const modal = document.getElementById('contactModal');
    if (modal) {
        modal.style.display = 'block';
        console.log('2. Modal opened');
    }
    
    const formFields = [
        document.getElementById('name'),           
        document.getElementById('businessName'),   
        document.getElementById('phone'),          
        document.getElementById('bestTime'),       
        document.getElementById('preferredDate')   
    ].filter(field => field !== null);
    
    console.log('3. Found fields:', formFields.length, formFields.map(f => f.id));
    
    if (formFields.length === 0) {
        console.log('4. ERROR: No fields found!');
        speakMessage("I don't see any form fields on this page.");
        return;
    }
    
    console.log('5. Calling startVoiceFormProcess...');
    startVoiceFormProcess(formFields);
}

function startVoiceFormProcess(fields) {
    console.log('6. Inside startVoiceFormProcess with', fields.length, 'fields');
    
    formFieldsArray = fields;
    currentFormFieldIndex = 0;
    isFormAssistantActive = true;
    
    console.log('7. Variables set, checking recognition...');
    
    // Initialize speech recognition for form filling
    if (!recognition) {
        console.log('8. Initializing speech recognition...');
        initializeSpeechRecognition();
    } else {
        console.log('8. Recognition already exists');
    }
    
    console.log('9. Creating form indicator...');
    createFormAssistIndicator();
    
    console.log('10. About to speak greeting...');
    speakMessage("Hi! Let me help you fill out this form. I'll ask you for each piece of information.");
    
    console.log('11. Setting timeout for first question...');
    setTimeout(() => {
        console.log('12. Timeout fired, calling askForNextFormField...');
        askForNextFormField();
    }, 3000);
}

function startVoiceFormProcess(fields) {
    formFieldsArray = fields;
    currentFormFieldIndex = 0;
    isFormAssistantActive = true;
    
    // Initialize speech recognition for form filling
    if (!recognition) {
        initializeSpeechRecognition();
    }
    
    // Create a small indicator that we're in form assist mode
    createFormAssistIndicator();
    
    // Start with greeting and first question
    speakMessage("Hi! Let me help you fill out this form. I'll ask you for each piece of information.");
    
    setTimeout(() => {
        askForNextFormField();
    }, 3000);
}

function createFormAssistIndicator() {
    const indicatorHTML = `
        <div id="formAssistIndicator" style="
            position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white;
            padding: 15px 20px; border-radius: 25px; z-index: 9999;
            box-shadow: 0 4px 15px rgba(76,175,80,0.4); display: flex; align-items: center; gap: 10px;
        ">
            <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/avatars/avatar_1754810337622_AI%20assist%20head%20left.png" 
                 style="width: 30px; height: 30px; border-radius: 50%;">
            <span style="font-weight: bold;">🗣️ Form Assistant Active</span>
            <button onclick="stopFormAssistant()" style="
                background: rgba(255,255,255,0.3); border: none; color: white; 
                border-radius: 50%; width: 25px; height: 25px; cursor: pointer;
            ">✕</button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', indicatorHTML);
}

function highlightCurrentField(field) {
    console.log('Highlighting field:', field.id);
    
    // Remove previous highlights
    document.querySelectorAll('input, select').forEach(f => {
        f.style.border = '';
        f.style.boxShadow = '';
    });
    
    // Highlight current field
    field.style.border = '3px solid #4CAF50';
    field.style.boxShadow = '0 0 15px rgba(76,175,80,0.6)';
    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function askForNextFormField() {
    console.log('13. Inside askForNextFormField, currentIndex:', currentFormFieldIndex);
    console.log('14. Total fields:', formFieldsArray.length);
    
    if (currentFormFieldIndex >= formFieldsArray.length) {
        console.log('15. All fields completed!');
        completeFormAssistant();
        return;
    }
    
    const currentField = formFieldsArray[currentFormFieldIndex];
    if (!currentField) {
        console.log('16. Current field is null, skipping...');
        currentFormFieldIndex++;
        askForNextFormField();
        return;
    }
    
    console.log('17. Processing field:', currentField.id);
    
    // Highlight the current field
    highlightCurrentField(currentField);
    
    // Ask for the appropriate information based on field type
    const question = getQuestionForField(currentField);
    console.log('18. Question:', question);
    speakMessage(question);
    
    // Start listening for the response
    setTimeout(() => {
        console.log('19. Starting to listen for response...');
        startFormFieldListening();
    }, 2000);
}

function startFormFieldListening() {
    console.log('20. Inside startFormFieldListening');
    
    if (!recognition) {
        console.log('21. No recognition available');
        speakMessage("Sorry, voice recognition isn't available. Please type your response in the highlighted field.");
        return;
    }
    
    // ⚡ KEY FIX: Don't restart if already listening
    if (isListening) {
        console.log('22. Already listening, no need to restart');
        return;
    }
    
    console.log('22. Starting speech recognition...');
    
    try {
        recognition.start();
        isListening = true;
        console.log('23. Recognition started successfully');
    } catch (error) {
        console.log('24. Recognition start error:', error);
        speakMessage("Please speak your response now, or type it in the highlighted field.");
    }
}


function getQuestionForField(field) {
    const fieldId = field.id?.toLowerCase() || '';
    const fieldName = field.name?.toLowerCase() || '';
    
    console.log('Getting question for field:', fieldId, fieldName);
    
    // Match your exact field IDs
    if (fieldId === 'name' || fieldName === 'name') {
        return "May I get your name please?";
    }
    
    if (fieldId === 'businessname' || fieldName === 'businessName') {
        return "What's your business name?";
    }
    
    if (fieldId === 'phone' || fieldName === 'phone') {
        return "What's your phone number?";
    }
    
    if (fieldId === 'besttime' || fieldName === 'bestTime') {
        return "What's the best time to contact you?";
    }
    
    if (fieldId === 'preferreddate' || fieldName === 'preferredDate') {
        return "What date would you prefer? Please say it like January 15th, 2025.";
    }
    
    // Generic fallback
    return `Please tell me your ${fieldId || fieldName || 'information'}.`;
}


function handleFormFieldResponse(response) {
    const currentField = formFieldsArray[currentFormFieldIndex];
    currentField && highlightCurrentField(currentField);
    if (!currentField) return;
    
    console.log('Filling field:', currentField.id, 'with:', response); // Debug log

    
    // Clean up the response
    const cleanResponse = response.trim();
    
    // Special handling for date fields
    if (currentField.type === 'date') {
        // Try to convert spoken date to YYYY-MM-DD format
        const dateValue = convertSpokenDateToFormat(cleanResponse);
        currentField.value = dateValue;
    } else {
        currentField.value = cleanResponse;
    }
    
    // Force the form to recognize the change
    currentField.focus();
    currentField.dispatchEvent(new Event('input', { bubbles: true }));
    currentField.dispatchEvent(new Event('change', { bubbles: true }));
    currentField.dispatchEvent(new Event('blur', { bubbles: true }));
    
    // Visual confirmation
    currentField.style.backgroundColor = '#e8f5e9'; // Light green background
    
    setTimeout(() => {
        currentField.style.backgroundColor = ''; // Reset background
    }, 2000);
    
    // Confirm the entry
    speakMessage(`Perfect! I've recorded: ${cleanResponse}`);
    
    // Move to next field after a delay
    setTimeout(() => {
        currentFormFieldIndex++;
        setTimeout(() => {
            askForNextFormField();
            startFormFieldListening();
        }, 1000);
    }, 1500);
}

// Helper function for date conversion
function convertSpokenDateToFormat(spokenDate) {
    // Simple date conversion - you can make this more sophisticated
    const today = new Date();
    
    if (spokenDate.toLowerCase().includes('today')) {
        return today.toISOString().split('T')[0];
    }
    
    if (spokenDate.toLowerCase().includes('tomorrow')) {
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        return tomorrow.toISOString().split('T')[0];
    }
    
    // For now, return today's date - you can improve this
    return today.toISOString().split('T')[0];
}

function completeFormAssistant() {
    speakMessage("Thank you for allowing me to fill in the form. And for a special, we'd like to offer for you a five hundred dollar discount certificate off your closing costs that you'll receive once you submit your quote request. Have a wonderful day!");
    
    // Optional: Add a visual message too
    setTimeout(() => {
        const specialOfferHTML = `
            <div id="specialOffer" style="
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4CAF50, #45a049); color: white;
                padding: 25px; border-radius: 15px; z-index: 10000; text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px;
            ">
                <h3 style="margin: 0 0 15px 0; font-size: 22px;">🎉 Special Offer!</h3>
                <p style="margin: 0 0 15px 0; font-size: 16px;">$500 Discount Certificate</p>
                <p style="margin: 0 0 20px 0; font-size: 14px;">Off your closing costs when you submit your quote!</p>
                <button onclick="document.getElementById('specialOffer').remove()" style="
                    background: white; color: #4CAF50; border: none; padding: 10px 20px;
                    border-radius: 8px; font-weight: bold; cursor: pointer;
                ">Awesome! 🎯</button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', specialOfferHTML);
        
        // Auto-remove after 8 seconds
        setTimeout(() => {
            const offer = document.getElementById('specialOffer');
            if (offer) offer.remove();
        }, 8000);
        
    }, 3000); // Show visual after speaking
    
    // Clean up form assistant after message
    setTimeout(() => {
        stopFormAssistant();
    }, 12000); // Give time for the full message and offer display
}

function stopFormAssistant() {
    isFormAssistantActive = false;
    currentFormFieldIndex = 0;
    formFieldsArray = [];
    
    // Remove indicator
    const indicator = document.getElementById('formAssistIndicator');
    if (indicator) indicator.remove();
    
    // Remove field highlighting
    document.querySelectorAll('input, select').forEach(field => {
        field.style.border = '';
        field.style.boxShadow = '';
    });
    
    // Stop speech recognition
    if (recognition) {
        try {
           // recognition.stop();
        } catch (error) {
            console.log('Recognition stop error:', error);
        }
    }
    
    isListening = false;
}

function speakMessage(message) {
    if (!speechSynthesis) return;
    
    const utterance = new SpeechSynthesisUtterance(message);
    
    const voices = speechSynthesis.getVoices();
    const femaleVoice = voices.find(voice => 
        voice.name.includes('Female') || 
        voice.name.includes('Samantha') || 
        voice.name.includes('Karen') ||
        voice.name.includes('Victoria')
    );
    
    if (femaleVoice) utterance.voice = femaleVoice;
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    utterance.volume = 0.8;
    
    speechSynthesis.speak(utterance);
}

// ============================================================================
// FIX 2: CHAT INTERFACE WITH SIMPLE PHONE EMOJI BUTTON
// ============================================================================

function createEnhancedChatInterface() {
    const chatHTML = `
        <div id="aiChatInterface" style="
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; height: 600px; background: white; 
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000; display: flex; flex-direction: column;
        ">
            <!-- Enhanced Header with Avatar and SIMPLE PHONE BUTTON -->
            <div style="
                background: linear-gradient(135deg, #2196F3, #1976D2); color: white; 
                padding: 15px; border-radius: 15px 15px 0 0; position: relative;
                display: flex; align-items: center; justify-content: space-between;
            ">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/avatars/avatar_1754810337622_AI%20assist%20head%20left.png" 
                         style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;">
                    <h3 style="margin: 0; font-size: 18px;"> 🎤 AI Audible Assist</h3>
                </div>
                
                <div style="display: flex; gap: 8px; align-items: center;">
                    <!-- SIMPLE PHONE EMOJI BUTTON -->
                    <button onclick="showCallbackFormFromChat()" style="
                        background: rgba(255,255,255,0.2); color: white; border: none; 
                        padding: 8px 12px; border-radius: 8px; font-size: 16px; cursor: pointer; 
                        transition: all 0.3s; font-weight: bold;
                    " title="Request a callback" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        📞 Fast Callback
                    </button>
                    <button onclick="closeAllAIInterfaces()" style="
                        background: none; border: none; color: white; font-size: 20px; cursor: pointer;
                    ">❌</button>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div id="chatMessages" style="
                flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa;
            "></div>
            
            <!-- Voice Indicator -->
            <div id="voiceIndicator" style="
                display: none; padding: 10px; background: #e8f5e8; border-top: 1px solid #ddd;
                text-align: center; color: #4CAF50; font-weight: bold;
            ">
                🎤 Listening... (speak now)
            </div>
            
            <!-- Enhanced Input Area with Custom Mic -->
            <div style="padding: 15px; border-top: 1px solid #eee; background: white;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="userChatInput" placeholder="Ask about mortgages or click mic to speak..." 
                           style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px;"
                           onkeypress="if(event.key==='Enter') sendChatMessage()">
                    
                    <!-- Custom Mic Button -->
                    <button id="voiceChatButton" onclick="toggleVoiceChat()" style="
                        background: none; border: none; cursor: pointer; padding: 5px;
                        transition: all 0.3s; border-radius: 50%;
                    " title="Click to speak">
                        <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/form-assets/logos/logo_5f42f026-051a-42c7-833d-375fcac74252_1754805748261_mic.png" 
                             style="width: 50px; height: 50px;" id="micIcon">
                    </button>
                    
                    <button onclick="sendChatMessage()" style="
                        background: #2196F3; color: white; border: none; border-radius: 50%;
                        width: 45px; height: 45px; cursor: pointer; font-size: 16px;
                    ">➤</button>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">
                    💡 Tip: Click the microphone and speak your question!
                </div>
            </div>
        </div>
        
        <div id="aiBackdrop" onclick="closeAllAIInterfaces()" style="
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
        "></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', chatHTML);
    isVoiceChatMode = true;
    document.getElementById('userChatInput').focus();
}

// ============================================================================
// VAPI CALLBACK SYSTEM (Unchanged - Working)
// ============================================================================

function showCallbackForm() {
    closeAllAIInterfaces();
    createCallbackInterface();
}

function showCallbackFormFromChat() {
    closeAllAIInterfaces();
    createCallbackInterface();
}

function createCallbackInterface() {
    const callbackHTML = `
        <div id="callbackInterface" style="
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 450px; background: white; border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 10000; padding: 30px;
        ">
            <!-- Header with Avatar -->
            <div style="text-align: center; margin-bottom: 25px;">
                <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/avatars/avatar_1754861585921_AI%20assist%20left2.png" 
                     <img src="..." style="height: 130px; width: auto; margin: 0 auto 20px auto; display: block; box-shadow: 0 0px 0px rgba(0,0,0,0.2);">
<h2 style="margin: 0; color: #333; font-size: 24px;">Want More Options?</h2>
                <h2 style="margin: 0; color: #333; font-size: 24px;">📞 Request a Callback</h2>
                <p style="color: #666; margin: 10px 0 0 0;">I'll call you back within minutes!</p>
            </div>
            
            <!-- Callback Form -->
            <form id="callbackForm" style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Your Name:</label>
                    <input type="text" id="callbackName" required style="
                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px;
                        font-size: 16px; transition: border-color 0.3s;
                    " placeholder="Enter your full name">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Phone Number:</label>
                    <input type="tel" id="callbackPhone" required style="
                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px;
                        font-size: 16px; transition: border-color 0.3s;
                    " placeholder="(555) 123-4567">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Best Time to Call:</label>
                    <select id="callbackTime" style="
                        width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px;
                        font-size: 16px; background: white;
                    ">
                        <option value="Now">Right Now</option>
                        <option value="Morning">Morning (9 AM - 12 PM)</option>
                        <option value="Afternoon">Afternoon (12 PM - 5 PM)</option>
                        <option value="Evening">Evening (5 PM - 8 PM)</option>
                    </select>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" style="
                        flex: 1; background: linear-gradient(135deg, #26C6DA, #00ACC1); color: white;
                        border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold;
                        cursor: pointer; transition: all 0.3s;
                    " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        📞 Call Me Now!
                    </button>
                    
                    <button type="button" onclick="closeAllAIInterfaces()" style="
                        background: #f44336; color: white; border: none; padding: 15px 20px;
                        border-radius: 10px; cursor: pointer; transition: all 0.3s;
                    ">❌</button>
                </div>
            </form>
            
            <!-- Status Message -->
            <div id="callbackStatus" style="
                display: none; margin-top: 15px; padding: 15px; border-radius: 10px;
                text-align: center; font-weight: bold;
            "></div>
        </div>
        
        <div id="aiBackdrop" onclick="closeAllAIInterfaces()" style="
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
        "></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', callbackHTML);
    
    // Add form submission handler
    document.getElementById('callbackForm').addEventListener('submit', handleCallbackRequest);
    document.getElementById('callbackName').focus();
}

// Make.com Webhook Integration
async function handleCallbackRequest(event) {
    event.preventDefault();
    
    const name = document.getElementById('callbackName').value.trim();
    const phone = document.getElementById('callbackPhone').value.trim();
    const time = document.getElementById('callbackTime').value;
    
    if (!name || !phone) {
        showCallbackStatus('Please fill in all required fields.', 'error');
        return;
    }
    
    showCallbackStatus('Requesting callback... Please wait!', 'loading');
    
    try {
        // Make.com Webhook Integration
        const webhookResponse = await fetch(VAPI_CONFIG.webhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                phone: phone,
                preferredTime: time,
                source: 'MortgageAssist Demo',
                assistantId: VAPI_CONFIG.assistantId,
                customMessage: `Hi ${name}! This is your AI mortgage assistant. You requested a callback about mortgage assistance. How can I help you today?`
            })
        });
        
        if (webhookResponse.ok) {
            showCallbackStatus(`Success! I'm calling ${phone} now. Please answer your phone!`, 'success');
            
            setTimeout(() => {
                closeAllAIInterfaces();
            }, 3000);
        } else {
            throw new Error('Webhook request failed');
        }
        
    } catch (error) {
        console.error('Make.com Webhook Error:', error);
        showCallbackStatus('Sorry, there was an issue with the callback request. Please try again or call us directly at (949) 332-3567.', 'error');
    }
}

function showCallbackStatus(message, type) {
    const statusDiv = document.getElementById('callbackStatus');
    if (!statusDiv) return;
    
    statusDiv.style.display = 'block';
    statusDiv.textContent = message;
    
    // Style based on type
    switch (type) {
        case 'success':
            statusDiv.style.background = '#e8f5e9';
            statusDiv.style.color = '#2e7d32';
            statusDiv.style.border = '2px solid #4caf50';
            break;
        case 'error':
            statusDiv.style.background = '#ffebee';
            statusDiv.style.color = '#c62828';
            statusDiv.style.border = '2px solid #f44336';
            break;
        case 'loading':
            statusDiv.style.background = '#e3f2fd';
            statusDiv.style.color = '#1976d2';
            statusDiv.style.border = '2px solid #2196f3';
            break;
    }
}

// ============================================================================
// VOICE CHAT SYSTEM (Unchanged - Working)
// ============================================================================

let micPermissionGranted = false; // Add this globally

function toggleVoiceChat() {
    if (isListening && isVoiceChatMode) {
        stopVoiceChatListening();
    } else if (isVoiceChatMode) {
        startVoiceChatListening();
    }
}

function startVoiceChatListening() {
    if (!recognition || isFormAssistantActive) {
        if (isFormAssistantActive) {
            addAIMessage("Form assistant is active. Please complete the form filling first.");
        } else {
            addAIMessage("Sorry, voice recognition isn't supported in your browser. Please type your question instead.");
        }
        return;
    }
    
    // Skip if already listening with permission granted
    if (isListening && micPermissionGranted) {
        console.log('Already listening with permission, skipping...');
        return;
    }
    
    isListening = true;
    const indicator = document.getElementById('voiceIndicator');
    const micIcon = document.getElementById('micIcon');
    
    if (indicator) indicator.style.display = 'block';
    if (micIcon) {
        micIcon.style.filter = 'brightness(0.7) sepia(1) hue-rotate(340deg) saturate(2)';
    }
    
    try {
        recognition.start();
        micPermissionGranted = true; // Flag permission as granted
        console.log('✅ Speech recognition started with permission cached');
    } catch (error) {
        console.log('Recognition start error:', error);
        stopVoiceChatListening();
    }
}

function stopVoiceChatListening() {
    // DON'T stop recognition if we're in form assistant mode
    if (isFormAssistantActive) {
        console.log('[DEBUG] Form assistant active - keeping mic alive');
        isListening = false; // Update flag but keep recognition running
        updateListenButton();
        return;
    }
    
    // Only stop recognition for chat mode
    isListening = false;
    if (recognition) {
        try {
            recognition.stop();
            console.log('[DEBUG] Recognition stopped for chat mode');
        } catch (error) {
            console.log('Recognition stop error:', error);
        }
    }
    updateListenButton();
}

function updateListenButton() {
    const indicator = document.getElementById('voiceIndicator');
    const micIcon = document.getElementById('micIcon');
    
    if (indicator) indicator.style.display = 'none';
    if (micIcon) {
        micIcon.style.filter = 'none'; // Normal color
    }
}

function handleVoiceChatInput(transcript) {
    addUserMessage(transcript);
    
    setTimeout(() => {
        const response = getSmartAIResponse(transcript);
        addAIMessage(response);
        speakResponse(response);
    }, 800);
    
    stopVoiceChatListening();
}

// Question Chat Function  
function startQuestionChat() {
    closeAllAIInterfaces();
    createEnhancedChatInterface();
    
    setTimeout(() => {
        addAIMessage("Hi! I'm your mortgage expert with a headset ready to help! You can type questions or click the microphone to speak with me! 🎤");
        addAIMessage("I can help with: Loan types, qualification, down payments, interest rates, and more!");
        showMortgageQuickOptions();
    }, 500);
}

// Chat Functions
function sendChatMessage() {
    const input = document.getElementById('userChatInput');
    if (!input) return;
    
    const message = input.value.trim();
    if (!message) return;
    
    addUserMessage(message);
    input.value = '';
    
    setTimeout(() => {
        const response = getSmartAIResponse(message);
        addAIMessage(response);
    }, 800);
}

function addAIMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    chatMessages.insertAdjacentHTML('beforeend', `
        <div style="margin-bottom: 15px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
                <img src="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/avatars/avatar_1754810337622_AI%20assist%20head%20left.png" 
                     style="width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;">
                <div style="
                    background: #e8f5e8; padding: 12px 16px; border-radius: 15px 15px 15px 5px;
                    max-width: 75%; font-size: 14px; line-height: 1.4; word-wrap: break-word;
                ">${message}</div>
            </div>
        </div>
    `);
    scrollChatToBottom();
}

function addUserMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    chatMessages.insertAdjacentHTML('beforeend', `
        <div style="margin-bottom: 15px; text-align: right;">
            <div style="display: flex; align-items: flex-start; gap: 10px; justify-content: flex-end;">
                <div style="
                    background: #2196f3; color: white; padding: 12px 16px; 
                    border-radius: 15px 15px 5px 15px; max-width: 75%; 
                    font-size: 14px; line-height: 1.4; word-wrap: break-word;
                ">${message}</div>
                <div style="
                    background: #2196f3; color: white; border-radius: 50%; 
                    width: 30px; height: 30px; display: flex; align-items: center; 
                    justify-content: center; font-size: 14px; flex-shrink: 0;
                ">👤</div>
            </div>
        </div>
    `);
    scrollChatToBottom();
}

// Enhanced AI Response System
function getSmartAIResponse(message) {
    const msg = message.toLowerCase();
    
    for (const [key, value] of Object.entries(mortgageKnowledge.expertResponses)) {
        if (msg.includes(key) || msg.includes(key.replace(/\s+/g, ''))) {
            return value;
        }
    }
    
    if (msg.includes('rate') || msg.includes('interest')) {
        return mortgageKnowledge.expertResponses['interest rates'];
    }
    if (msg.includes('qualify') || msg.includes('eligible')) {
        return mortgageKnowledge.expertResponses['qualification'];
    }
    if (msg.includes('fha') || msg.includes('va') || msg.includes('usda')) {
        return mortgageKnowledge.expertResponses['loan types'];
    }
    
    return "Great question! I'm here to help with mortgages, loan types, qualification, rates, and home buying. Could you be more specific? For example, ask me 'What credit score do I need?' or 'What are current rates?'";
}

// Quick Options
function showMortgageQuickOptions() {
    const options = `
        <div style="margin: 15px 0;">
            <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Quick topics:</p>
            <button onclick="askQuickQuestion('What credit score do I need?')" class="chat-quick-btn">📊 Credit Score</button>
            <button onclick="askQuickQuestion('What loan types are available?')" class="chat-quick-btn">🏠 Loan Types</button>
            <button onclick="askQuickQuestion('How much down payment?')" class="chat-quick-btn">💰 Down Payment</button>
            <button onclick="askQuickQuestion('What are current rates?')" class="chat-quick-btn">📈 Interest Rates</button>
        </div>
        
        <style>
            .chat-quick-btn {
                background: #e3f2fd; border: 1px solid #2196f3; border-radius: 20px;
                padding: 6px 12px; margin: 2px; font-size: 11px; cursor: pointer;
                color: #1976d2; transition: all 0.3s;
            }
            .chat-quick-btn:hover {
                background: #2196f3; color: white; transform: scale(1.05);
            }
        </style>
    `;
    
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.insertAdjacentHTML('beforeend', options);
        scrollChatToBottom();
    }
}

function askQuickQuestion(question) {
    addUserMessage(question);
    setTimeout(() => {
        const response = getSmartAIResponse(question);
        addAIMessage(response);
        speakResponse(response);
    }, 500);
}

// Voice Response
function speakResponse(text) {
    if (!speechSynthesis) return;
    
    const cleanText = text.replace(/\*\*(.*?)\*\*/g, '$1').replace(/[📊🏠💰📈]/g, '');
    const utterance = new SpeechSynthesisUtterance(cleanText);
    
    const voices = speechSynthesis.getVoices();
    const femaleVoice = voices.find(voice => 
        voice.name.includes('Female') || 
        voice.name.includes('Samantha') || 
        voice.name.includes('Karen') ||
        voice.name.includes('Victoria')
    );
    
    if (femaleVoice) utterance.voice = femaleVoice;
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    utterance.volume = 0.8;
    
    speechSynthesis.speak(utterance);
}

// Utility Functions
function scrollChatToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function closeAllAIInterfaces() {
    const interfaces = ['aiOptionsMenu', 'aiChatInterface', 'callbackInterface', 'aiBackdrop', 'formAssistIndicator'];
    interfaces.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.remove();
    });
    
    // Clean up form highlighting
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.style.border = '';
        input.style.boxShadow = '';
    });
    
   // In closeAllAIInterfaces() around line 1377-1379
// COMMENT OUT OR REMOVE THIS ENTIRE BLOCK:
/*
if (recognition && isListening && !isFormAssistantActive) {
    try {
        recognition.stop(); // ← DELETE THIS!
        console.log('[DEBUG] Recognition stopped - interfaces closed');
    } catch (error) {
        console.log('Error stopping recognition:', error);
    }
}
*/
    
    if (speechSynthesis) {
        speechSynthesis.cancel();
    }
    
    // Reset all states
    isListening = false;
    isVoiceChatMode = false;
    isFormAssistantActive = false;
    currentFormFieldIndex = 0;
    formFieldsArray = [];
}


// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeSpeechRecognition();
});

speechSynthesis.onvoiceschanged = function() {
    console.log('Available voices:', speechSynthesis.getVoices().length);
};
</script>

</body>
</html>
