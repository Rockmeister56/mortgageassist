<script>
    let mainScript = null;
    let objectionsScript = null;

    // Activate Jack with avatar control
    function activateJack() {
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> ON';
        btn.style.background = '#10b981';
        
        // Activate the avatar widget
        const widget = document.querySelector('lemon-slice-widget');
        if (widget) {
            // Force mic and volume on
            widget.setAttribute('mic-enabled', 'true');
            widget.setAttribute('volume-enabled', 'true');
            widget.setAttribute('controlled-widget-state', 'active');
            
            showStatus('üéôÔ∏è Jack activated - mic & volume on');
        }
        
        // Send message if in popup mode
        if (window.opener && window.opener.postMessage) {
            window.opener.postMessage({
                type: 'MODULE_TRIGGERED',
                module: 'personality',
                triggerPhrase: "You're Jack"
            }, '*');
        }
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '#3b82f6';
        }, 1500);
    }

    // Google Voice Call
    function callWithGoogleVoice() {
        const phoneInput = document.getElementById('phoneNumber').value;
        const phoneNumber = phoneInput.replace(/\D/g, '');
        
        if (phoneNumber.length < 10) {
            alert('Please enter a valid phone number');
            return;
        }
        
        // Format for Google Voice
        let formattedNumber = phoneNumber;
        if (formattedNumber.length === 10) {
            formattedNumber = '1' + formattedNumber;
        }
        
        // Open Google Voice
        window.open(`https://voice.google.com/u/0/calls?a=new&number=%2B${formattedNumber}`, '_blank');
        showStatus('üìû Google Voice opened');
    }

    // Status helper
    function showStatus(message) {
        let statusDiv = document.getElementById('jack-status');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'jack-status';
            statusDiv.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #10b981;
                color: white;
                padding: 8px 20px;
                border-radius: 30px;
                font-size: 0.9rem;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                border: 1px solid #34d399;
            `;
            document.body.appendChild(statusDiv);
        }
        
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 2000);
    }

    // Main Script Upload
    document.getElementById('mainScriptInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type === 'application/pdf') {
            if (mainScript) URL.revokeObjectURL(mainScript.url);
            const url = URL.createObjectURL(file);
            mainScript = { url, name: file.name };
            document.getElementById('mainViewer').innerHTML = `<iframe src="${url}" width="100%" height="100%" style="border: none;"></iframe>`;
            showStatus('üìÑ Main script loaded');
        }
    });

    // Objections Upload
    document.getElementById('objectionsInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type === 'application/pdf') {
            if (objectionsScript) URL.revokeObjectURL(objectionsScript.url);
            const url = URL.createObjectURL(file);
            objectionsScript = { url, name: file.name };
            document.getElementById('objectionsViewer').innerHTML = `<iframe src="${url}" width="100%" height="100%" style="border: none;"></iframe>`;
            showStatus('üõ°Ô∏è Objections loaded');
        }
    });

    // Format phone number
    document.getElementById('phoneNumber').addEventListener('input', function(e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
    });

    // Auto-hide filename badges (they're not in HTML anymore)
    window.onload = function() {
        // Any initialization needed
    };
</script>